<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Enrichment - {{ brand_name }} | TTB Enrichment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enrichment_review.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <a href="{{ url_for('index') }}" class="nav-brand">TTB Enrichment</a>
                <div class="nav-links">
                    <a href="{{ url_for('dashboard_page') }}">Dashboard</a>
                    <a href="{{ url_for('brands_page') }}" class="nav-active">Brands</a>
                    <a href="{{ url_for('importers_page') }}">Importers</a>
                    <a href="{{ url_for('producers_page') }}">Producers</a>
                    <a href="{{ url_for('data_page') }}">Data</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="page-title">
                        <i class="fas fa-search-plus"></i>
                        Review Enrichment
                    </h1>
                    <div class="breadcrumb">
                        <a href="{{ url_for('brands_page') }}">Brands</a>
                        <span class="breadcrumb-separator">/</span>
                        <a href="{{ url_for('brand_detail_page', brand_name=brand_name) }}">{{ brand_name }}</a>
                        <span class="breadcrumb-separator">/</span>
                        <span>Review Enrichment</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="enrichment-status">
                        <span class="status-badge {{ enrichment.get('status', 'pending') }}">{{ enrichment.get('status', 'pending')|title }}</span>
                        <span class="confidence-score">{{ (enrichment.get('confidence', 0) * 100)|round }}% Confidence</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Content -->
        <div class="review-container">
            <!-- Left Panel: Original TTB Data -->
            <div class="review-panel original-data">
                <div class="panel-header">
                    <h2><i class="fas fa-database"></i> TTB Registry Data</h2>
                    <span class="data-source">Source: TTB COLA Database</span>
                </div>
                
                <div class="data-section">
                    <div class="data-item">
                        <label>Brand Name:</label>
                        <div class="data-value">{{ brand_name }}</div>
                    </div>
                    
                    {% if original_data.class_types %}
                    <div class="data-item">
                        <label>Product Types:</label>
                        <div class="data-value">
                            {% for class_type in original_data.class_types %}
                                <span class="type-tag">{{ class_type }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if original_data.countries %}
                    <div class="data-item">
                        <label>Countries:</label>
                        <div class="data-value">
                            {% for country in original_data.countries %}
                                <span class="country-tag">{{ country }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="data-item">
                        <label>SKUs:</label>
                        <div class="data-value">{{ original_data.sku_count }} registered products</div>
                    </div>
                    
                    {% if original_data.importers %}
                    <div class="data-item">
                        <label>Importers:</label>
                        <div class="data-value">
                            {% for importer in original_data.importers[:2] %}
                                <div class="importer-item">{{ importer.owner_name or importer.operating_name }}</div>
                            {% endfor %}
                            {% if original_data.importers|length > 2 %}
                                <span class="more-indicator">+{{ original_data.importers|length - 2 }} more</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Panel: Enrichment Data -->
            <div class="review-panel enrichment-data">
                <div class="panel-header">
                    <h2><i class="fas fa-globe"></i> Discovered Data</h2>
                    <span class="data-source">Source: Web Search & Analysis</span>
                </div>

                <div class="data-section">
                    <!-- Brand Verification -->
                    <div class="enrichment-item">
                        <div class="item-header">
                            <h3><i class="fas fa-check-circle"></i> Brand Verification</h3>
                            {% if enrichment.get('founders') or enrichment.get('website') %}
                                <span class="verification-status verified">✅ Verified</span>
                            {% else %}
                                <span class="verification-status unverified">❌ Not Found</span>
                            {% endif %}
                        </div>
                        <div class="item-content">
                            {% if enrichment.get('founders') or enrichment.get('website') %}
                                <p class="verification-text">Brand identity confirmed through web presence and founder information.</p>
                            {% else %}
                                <p class="verification-text">No clear brand verification found. Manual research may be needed.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Website -->
                    <div class="enrichment-item" data-field="website">
                        <div class="item-header">
                            <h3><i class="fas fa-globe"></i> Official Website</h3>
                            {% if enrichment.get('website') %}
                            <button class="edit-btn" onclick="editField('website')">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </div>
                        <div class="item-content">
                            {% if enrichment.get('website') %}
                            <div class="website-info">
                                <div class="display-value">
                                    <strong>{{ enrichment.get('website', {}).get('domain', '') }}</strong>
                                    <a href="{{ enrichment.get('website', {}).get('url', '#') }}" target="_blank" class="external-link">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                                <div class="edit-value" style="display: none;">
                                    <input type="text" class="form-input" value="{{ enrichment.get('website', {}).get('domain', '') }}" />
                                    <div class="edit-actions">
                                        <button onclick="saveField('website')" class="btn btn-sm btn-success">Save</button>
                                        <button onclick="cancelEdit('website')" class="btn btn-sm btn-secondary">Cancel</button>
                                    </div>
                                </div>
                            </div>
                            <div class="data-source">Source: {{ enrichment.get('website', {}).get('source', 'unknown') }}</div>
                            {% else %}
                            <!-- Check if multi-choice options are available -->
                            {% if website_options and website_options.needs_selection %}
                            <div class="website-multi-choice">
                                <div class="multi-choice-header">
                                    <i class="fas fa-search-plus"></i>
                                    <div class="header-content">
                                        <h4>Multiple Website Options Found</h4>
                                        <p>The AI found several potential websites. Please select the most appropriate one:</p>
                                    </div>
                                </div>
                                
                                <div class="website-options">
                                    {% for option in website_options.options %}
                                    <div class="website-option" data-rank="{{ option.rank }}">
                                        <div class="option-header">
                                            <div class="option-title">
                                                <strong>Option {{ option.rank }}</strong>
                                                <span class="confidence-badge">{{ (option.final_confidence * 100)|round }}% confident</span>
                                            </div>
                                            <div class="option-domain">
                                                <a href="{{ option.url }}" target="_blank">{{ option.domain }}</a>
                                                <i class="fas fa-external-link-alt"></i>
                                            </div>
                                        </div>
                                        <div class="option-details">
                                            <div class="option-snippet">{{ option.snippet|truncate(150) }}</div>
                                            <div class="option-reasoning">
                                                <strong>Why this option:</strong> {{ option.reasoning }}
                                            </div>
                                        </div>
                                        <div class="option-actions">
                                            <button onclick="selectWebsiteOption('{{ brand_name }}', '{{ option.url }}', {{ option.rank }})" 
                                                    class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i> Select This Website
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="multi-choice-actions">
                                    <button onclick="rejectAllOptions('{{ brand_name }}')" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> None of These Are Correct
                                    </button>
                                    <button onclick="showManualInput('{{ brand_name }}')" class="btn btn-outline">
                                        <i class="fas fa-edit"></i> Enter Manually
                                    </button>
                                </div>
                            </div>
                            <div class="data-source">Source: Multi-choice learning system</div>
                            {% else %}
                            <div class="website-not-found">
                                <div class="not-found-message">
                                    <i class="fas fa-filter"></i>
                                    <div class="message-content">
                                        <h4>No Suitable Website Found</h4>
                                        <p>Search completed but results were filtered out as irrelevant (Wikipedia, historical content, etc.). The intelligent search system found search results but they were not related to the brand's business website.</p>
                                        <div class="search-strategies">
                                            <strong>Search strategies used:</strong>
                                            <ul>
                                                <li>Direct brand name search: "{{ brand_name }}"</li>
                                                {% if original_data.class_types %}
                                                <li>Brand + product type: "{{ brand_name }}" {{ original_data.class_types[0].lower() }}</li>
                                                {% endif %}
                                                {% if original_data.countries %}
                                                <li>Brand + origin: "{{ brand_name }}" {{ original_data.countries[0].lower() }}</li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                        <div class="manual-action">
                                            <p><strong>Recommendation:</strong> Manual research may be needed or the website might not exist yet.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="data-source">Source: Intelligent search with filtering</div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Founders -->
                    {% if enrichment.get('founders') %}
                    <div class="enrichment-item editable" data-field="founders">
                        <div class="item-header">
                            <h3><i class="fas fa-users"></i> Founders & Leadership</h3>
                            <button class="edit-btn" onclick="editField('founders')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div class="item-content">
                            <div class="display-value">
                                {% for founder in enrichment.get('founders', []) %}
                                <div class="founder-item">
                                    <div class="founder-name">{{ founder['name'] if founder is mapping else founder.name }}</div>
                                    <div class="founder-details">
                                        <span class="confidence-badge">{{ ((founder['confidence'] if founder is mapping else founder.confidence) * 100)|round }}% confidence</span>
                                        {% set sources = founder['sources'] if founder is mapping else founder.sources %}
                                        {% if sources %}
                                            <span class="source-count">{{ sources|length }} sources</span>
                                        {% endif %}
                                    </div>
                                    {% set context = founder['context'] if founder is mapping else founder.context %}
                                    {% if context %}
                                        <div class="founder-context">"{{ context[:100] }}..."</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="edit-value" style="display: none;">
                                <textarea class="form-input" rows="4" placeholder="Enter founder names (one per line)">{% for founder in enrichment.get('founders', []) %}{{ founder['name'] if founder is mapping else founder.name }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
                                <div class="edit-actions">
                                    <button onclick="saveField('founders')" class="btn btn-sm btn-success">Save</button>
                                    <button onclick="cancelEdit('founders')" class="btn btn-sm btn-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- LinkedIn Profiles -->
                    {% if enrichment.get('linkedin_profiles') %}
                    <div class="enrichment-item">
                        <div class="item-header">
                            <h3><i class="fab fa-linkedin"></i> LinkedIn Profiles</h3>
                        </div>
                        <div class="item-content">
                            {% for profile in enrichment.get('linkedin_profiles', []) %}
                            <div class="linkedin-item">
                                <div class="profile-name">{{ profile['name'] if profile is mapping else profile.name }}</div>
                                <div class="profile-title">{{ (profile['title'] if profile is mapping else profile.title) or 'Executive' }}</div>
                                <a href="{{ profile['url'] if profile is mapping else profile.url }}" target="_blank" class="profile-link">
                                    View Profile <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Apollo Contacts (Future) -->
                    {% if enrichment.get('apollo_contacts') %}
                    <div class="enrichment-item">
                        <div class="item-header">
                            <h3><i class="fas fa-address-book"></i> Contact Information</h3>
                            <span class="premium-badge">Apollo.io</span>
                        </div>
                        <div class="item-content">
                            <p class="coming-soon">Contact discovery will be available when Apollo.io integration is enabled.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Review Actions -->
        <div class="review-actions">
            <div class="actions-container">
                <div class="action-group primary-actions">
                    <button id="approve-btn" class="btn btn-success btn-lg" onclick="approveEnrichment()">
                        <i class="fas fa-check"></i>
                        Approve & Save
                    </button>
                    <button id="reject-btn" class="btn btn-danger btn-lg" onclick="rejectEnrichment()">
                        <i class="fas fa-times"></i>
                        Reject
                    </button>
                </div>
                
                <div class="action-group secondary-actions">
                    <button class="btn btn-secondary" onclick="researchBrand()">
                        <i class="fas fa-redo"></i>
                        Re-search
                    </button>
                    <a href="{{ url_for('brands_page') }}" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i>
                        Back to Brands
                    </a>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="notes-section">
                <label for="review-notes">Review Notes (Optional):</label>
                <textarea id="review-notes" class="form-input" rows="3" 
                          placeholder="Add any notes about this enrichment review..."></textarea>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Processing...</h3>
            <p id="loading-message">Saving your review...</p>
        </div>
    </div>

    <script>
        // Pass data to JavaScript
        window.brandData = {
            name: {{ brand_name|tojson }},
            enrichment: {{ enrichment|tojson }},
            originalData: {{ original_data|tojson }}
        };
    </script>
    <script src="{{ url_for('static', filename='js/enrichment_review.js') }}"></script>
</body>
</html>